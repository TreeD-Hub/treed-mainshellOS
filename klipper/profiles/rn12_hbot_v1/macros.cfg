# ==========================================
# БАЗОВЫЕ МАКРОСЫ ПЕЧАТИ TreeD (RN12 HBOT V1)
# ==========================================
# Контракт:
# - Слайсер должен вызывать:
#   START_PRINT EXTRUDER_TEMP=<temp> BED_TEMP=<temp>
# - Макрос использует M83 (относительная подача E) и не сбрасывает множители скорости/потока.
# - Сессия камеры управляется макросами TREED_CAM_*.

[gcode_macro TREED_PRINT_DEFAULTS]
description: "TreeD: дефолты макросов печати и камеры"
variable_prime_e: 16.0
variable_prime_z: 0.40
variable_prime_feed: 400.0
variable_snapshot_interval: 120
gcode:

[gcode_macro START_PRINT]
description: "TreeD: старт печати (валидация, нагрев, хоуминг, прайм, камера)"
gcode:
  # ---- 1) Чтение и нормализация параметров из слайсера ----
  {% set defaults = printer["gcode_macro TREED_PRINT_DEFAULTS"] %}
  {% set BED_TEMP = params.BED_TEMP|default(0)|float %}
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(0)|float %}
  {% set PRIME_E = params.PRIME_E|default(defaults.prime_e)|float %}
  {% set PRIME_Z = params.PRIME_Z|default(defaults.prime_z)|float %}
  {% set PRIME_FEED = params.PRIME_FEED|default(defaults.prime_feed)|float %}

  {% if BED_TEMP < 0 %}{% set BED_TEMP = 0.0 %}{% endif %}
  {% if EXTRUDER_TEMP < 0 %}{% set EXTRUDER_TEMP = 0.0 %}{% endif %}
  {% if PRIME_E < 2 %}{% set PRIME_E = 2.0 %}{% endif %}
  {% if PRIME_E > 30 %}{% set PRIME_E = 30.0 %}{% endif %}
  {% if PRIME_Z < 0.20 %}{% set PRIME_Z = 0.20 %}{% endif %}
  {% if PRIME_Z > 1.20 %}{% set PRIME_Z = 1.20 %}{% endif %}
  {% if PRIME_FEED < 120 %}{% set PRIME_FEED = 120.0 %}{% endif %}
  {% if PRIME_FEED > 1800 %}{% set PRIME_FEED = 1800.0 %}{% endif %}

  {% set has_bed = printer.heater_bed is defined %}
  {% set min_extrude = printer.configfile.settings.extruder.min_extrude_temp|default(170)|float %}

  {% if EXTRUDER_TEMP <= 0 %}
    {action_raise_error("START_PRINT: требуется EXTRUDER_TEMP > 0")}
  {% endif %}
  {% if EXTRUDER_TEMP < min_extrude %}
    {action_raise_error("START_PRINT: EXTRUDER_TEMP ниже min_extrude_temp (" ~ min_extrude ~ ")")}
  {% endif %}

  # ---- 2) Геометрия для безопасных перемещений и прайм-линии ----
  {% set toolhead = printer.toolhead %}
  {% set x_min = toolhead.axis_minimum.x|float %}
  {% set y_min = toolhead.axis_minimum.y|float %}
  {% set z_min = toolhead.axis_minimum.z|float %}
  {% set x_max = toolhead.axis_maximum.x|float %}
  {% set y_max = toolhead.axis_maximum.y|float %}
  {% set z_max = toolhead.axis_maximum.z|float %}

  {% set safe_z = 10.0 %}
  {% if safe_z > z_max - 1.0 %}{% set safe_z = z_max - 1.0 %}{% endif %}
  {% if safe_z < z_min + 0.5 %}{% set safe_z = z_min + 0.5 %}{% endif %}

  {% set prime_y = y_min + 5.0 %}
  {% if prime_y > y_max - 5.0 %}{% set prime_y = (y_min + y_max) / 2.0 %}{% endif %}

  {% set prime_x_start = x_min + 20.0 %}
  {% if prime_x_start > x_max - 30.0 %}
    {% set prime_x_start = x_min + (x_max - x_min) * 0.2 %}
  {% endif %}

  {% set prime_x_end = x_max - 20.0 %}
  {% if prime_x_end <= prime_x_start + 12.0 %}
    {% set prime_x_end = prime_x_start + 12.0 %}
  {% endif %}

  {% set prime_len = prime_x_end - prime_x_start %}
  {% if prime_len < 12.0 %}{% set prime_len = 12.0 %}{% endif %}

  {% set prime_x_mid = prime_x_start + prime_len * 0.6 %}
  {% if prime_x_mid > prime_x_end %}
    {% set prime_x_mid = (prime_x_start + prime_x_end) / 2.0 %}
  {% endif %}

  {% set wipe_x = prime_x_end - 5.0 %}
  {% if wipe_x < prime_x_start %}{% set wipe_x = prime_x_end %}{% endif %}

  # ---- 3) Базовый режим G-кода (множители скорости/потока не трогаем) ----
  G21
  G90
  M83
  G92 E0

  # ---- 4) Преднагрев ----
  # Стол греем параллельно, если heater_bed есть и цель > 0.
  {% if has_bed and BED_TEMP > 0 %}
    M140 S{BED_TEMP}
  {% elif has_bed and BED_TEMP <= 0 %}
    RESPOND PREFIX="treed" MSG="BED_TEMP<=0, нагрев стола пропущен"
  {% endif %}

  # Мягкий преднагрев сопла перед хоумингом для снижения подтекания.
  {% set PREHEAT_NOZZLE = 140.0 %}
  {% if EXTRUDER_TEMP < PREHEAT_NOZZLE %}
    {% set PREHEAT_NOZZLE = EXTRUDER_TEMP %}
  {% endif %}
  {% if PREHEAT_NOZZLE > 0 %}
    M104 S{PREHEAT_NOZZLE}
  {% endif %}

  # ---- 5) Хоуминг и доведение до рабочих температур ----
  G28
  G1 Z{safe_z} F1200

  {% if has_bed and BED_TEMP > 0 %}
    M190 S{BED_TEMP}
  {% endif %}
  M109 S{EXTRUDER_TEMP}

  # ---- 6) Прайм-последовательность ----
  G92 E0
  G1 E-0.8 F1800

  G1 X{prime_x_start} Y{prime_y} Z{safe_z} F6000
  G1 Z{PRIME_Z} F600
  G92 E0
  G1 X{prime_x_mid} Y{prime_y} E{PRIME_E} F{PRIME_FEED}
  G1 Z{PRIME_Z + 0.2} F120
  G1 X{wipe_x} Y{prime_y} F3000
  G92 E0
  G1 Z2 F1200

  # ---- 7) Runtime-хуки ----
  TREED_CAM_START
  RESPOND PREFIX="treed" MSG="START_PRINT завершен: bed={BED_TEMP} hotend={EXTRUDER_TEMP}"

[gcode_macro END_PRINT]
description: "TreeD: завершение печати (подъем, парковка, охлаждение, стоп камеры)"
gcode:
  {% set toolhead = printer.toolhead %}
  {% set gcode_state = printer.gcode_move %}
  {% set has_bed = printer.heater_bed is defined %}

  {% set x_min = toolhead.axis_minimum.x|float %}
  {% set y_max = toolhead.axis_maximum.y|float %}
  {% set z_min = toolhead.axis_minimum.z|float %}
  {% set z_max = toolhead.axis_maximum.z|float %}

  {% set park_x = x_min + 10.0 %}
  {% set park_y = y_max - 10.0 %}
  {% set lift_z = gcode_state.position.z + 10.0 %}
  {% if lift_z > z_max - 1.0 %}{% set lift_z = z_max - 1.0 %}{% endif %}
  {% if lift_z < z_min + 2.0 %}{% set lift_z = z_min + 2.0 %}{% endif %}

  G90
  G92 E0
  G1 E-2 F1800
  G1 Z{lift_z} F1200
  G1 X{park_x} Y{park_y} F6000

  M106 S0
  M104 S0
  {% if has_bed %}
    M140 S0
  {% endif %}
  TREED_CAM_STOP
  RESPOND PREFIX="treed" MSG="END_PRINT завершен"

[gcode_macro CANCEL_PRINT]
description: "TreeD: отмена печати (остановка камеры + базовый CANCEL)"
rename_existing: CANCEL_PRINT_BASE
gcode:
  TREED_CAM_STOP
  CANCEL_PRINT_BASE

[gcode_macro PAUSE]
description: "TreeD: пауза печати (PAUSE_BASE + пауза снимков камеры)"
rename_existing: PAUSE_BASE
gcode:
  SET_GCODE_VARIABLE MACRO=TREED_CAM_STATE VARIABLE=was_enabled_before_pause VALUE={printer["gcode_macro TREED_CAM_STATE"].enabled|int}
  SET_GCODE_VARIABLE MACRO=TREED_CAM_STATE VARIABLE=enabled VALUE=0
  UPDATE_DELAYED_GCODE ID=TREED_CAM_TICK DURATION=0
  PAUSE_BASE

[gcode_macro RESUME]
description: "TreeD: продолжение печати (RESUME_BASE + восстановление снимков)"
rename_existing: RESUME_BASE
gcode:
  RESUME_BASE
  {% if printer["gcode_macro TREED_CAM_STATE"].was_enabled_before_pause|int == 1 %}
    SET_GCODE_VARIABLE MACRO=TREED_CAM_STATE VARIABLE=enabled VALUE=1
    UPDATE_DELAYED_GCODE ID=TREED_CAM_TICK DURATION=1
  {% endif %}
  SET_GCODE_VARIABLE MACRO=TREED_CAM_STATE VARIABLE=was_enabled_before_pause VALUE=0

# Состояние камеры:
# enabled = активный цикл снимков, was_enabled_before_pause = флаг для PAUSE/RESUME.
[gcode_macro TREED_CAM_STATE]
variable_enabled: 0
variable_was_enabled_before_pause: 0
gcode:

[delayed_gcode TREED_CAM_TICK]
initial_duration: 0
gcode:
  {% if printer["gcode_macro TREED_CAM_STATE"].enabled|int == 1 %}
    {% set interval = printer["gcode_macro TREED_PRINT_DEFAULTS"].snapshot_interval|int %}
    {% if interval < 10 %}{% set interval = 10 %}{% endif %}
    {action_call_remote_method("machine.shell_command", cmd="treed_cam_snapshot")}
    UPDATE_DELAYED_GCODE ID=TREED_CAM_TICK DURATION={interval}
  {% endif %}

[gcode_macro TREED_CAM_START]
description: "TreeD: камера (открыть сессию и запустить периодические снимки)"
gcode:
  {% if printer["gcode_macro TREED_CAM_STATE"].enabled|int == 0 %}
    SET_GCODE_VARIABLE MACRO=TREED_CAM_STATE VARIABLE=enabled VALUE=1
    SET_GCODE_VARIABLE MACRO=TREED_CAM_STATE VARIABLE=was_enabled_before_pause VALUE=0
    {action_call_remote_method("machine.shell_command", cmd="treed_cam_session_start", parameters=printer.print_stats.filename)}
    UPDATE_DELAYED_GCODE ID=TREED_CAM_TICK DURATION=1
  {% endif %}

[gcode_macro TREED_CAM_STOP]
description: "TreeD: камера (остановить периодические снимки и закрыть сессию)"
gcode:
  SET_GCODE_VARIABLE MACRO=TREED_CAM_STATE VARIABLE=enabled VALUE=0
  SET_GCODE_VARIABLE MACRO=TREED_CAM_STATE VARIABLE=was_enabled_before_pause VALUE=0
  {action_call_remote_method("machine.shell_command", cmd="treed_cam_session_stop")}
  UPDATE_DELAYED_GCODE ID=TREED_CAM_TICK DURATION=0
